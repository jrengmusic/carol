#!/bin/bash
# carol - CAROL Framework CLI Tool
# Version: 1.0.0

set -e

VERSION="1.0.0"
CAROL_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CAROL_REMOTE="${CAROL_REMOTE:-file://$CAROL_ROOT}"  # Default to local repo for testing

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${YELLOW}→ $1${NC}"
}

customize_templates() {
    local project_path="$1"
    local project_name=$(basename "$project_path")
    local date=$(date +"%Y-%m-%d")

    # Customize SESSION-LOG.md
    if [ -f ".carol/SESSION-LOG.md" ]; then
        sed -i.bak "s/\[Project Name\]/$project_name/g" .carol/SESSION-LOG.md
        sed -i.bak "s/\[YYYY-MM-DD\]/$date/g" .carol/SESSION-LOG.md
        sed -i.bak "s|\[repo-url or local path\]|$project_path|g" .carol/SESSION-LOG.md
        rm -f .carol/SESSION-LOG.md.bak
    fi

    # Customize config.yml
    if [ -f ".carol/config.yml" ]; then
        sed -i.bak "s/\[PROJECT_NAME\]/$project_name/g" .carol/config.yml
        sed -i.bak "s|\[PROJECT_PATH\]|$project_path|g" .carol/config.yml
        sed -i.bak "s/\[DATE\]/$date/g" .carol/config.yml
        rm -f .carol/config.yml.bak
    fi
}

cmd_init() {
    local project_path="."
    local portable=false

    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            --portable)
                portable=true
                shift
                ;;
            -*)
                error "Unknown flag: $1"
                ;;
            *)
                # First non-flag argument is project path
                if [ "$project_path" = "." ]; then
                    project_path="$1"
                fi
                shift
                ;;
        esac
    done

    # Change to project directory
    cd "$project_path" || error "Cannot access directory: $project_path"
    project_path="$(pwd)"

    # Check if .carol already exists
    if [ -d ".carol" ]; then
        error ".carol directory already exists. Remove it first or run 'carol update'"
    fi

    # Create .carol directory
    mkdir -p .carol

    if $portable; then
        # Portable mode: Clone full repository
        info "Initializing CAROL (portable mode)..."
        git clone "$CAROL_REMOTE" .carol || error "Failed to clone CAROL repository"

        # Remove .git if it's a local file:// clone (for testing)
        if [[ "$CAROL_REMOTE" == file://* ]]; then
            rm -rf .carol/.git
            info "Removed .git (local testing mode)"
        fi
    else
        # Symlink mode: Link to SSOT
        info "Initializing CAROL (symlink mode)..."

        # Symlink shared resources
        ln -s "$CAROL_ROOT/CAROL.md" .carol/CAROL.md
        ln -s "$CAROL_ROOT/AGENTS.md" .carol/AGENTS.md
        ln -s "$CAROL_ROOT/PATTERNS.md" .carol/PATTERNS.md
        ln -s "$CAROL_ROOT/SCRIPTS.md" .carol/SCRIPTS.md
        ln -s "$CAROL_ROOT/PATTERNS-WRITER.md" .carol/PATTERNS-WRITER.md
        ln -s "$CAROL_ROOT/SPEC-WRITER.md" .carol/SPEC-WRITER.md
        ln -s "$CAROL_ROOT/ARCHITECTURE-WRITER.md" .carol/ARCHITECTURE-WRITER.md
        ln -s "$CAROL_ROOT/scripts" .carol/scripts 2>/dev/null || info "scripts/ directory will be available when scripts are implemented"

        # Copy templates (project-specific)
        cp "$CAROL_ROOT/templates/SESSION-LOG.md" .carol/SESSION-LOG.md
        cp "$CAROL_ROOT/templates/ARCHITECTURE.md" .carol/ARCHITECTURE.md
        cp "$CAROL_ROOT/templates/config.yml" .carol/config.yml

        # Mark as symlink mode in config
        sed -i.bak 's/mode: "symlink"/mode: "symlink"/' .carol/config.yml
        rm -f .carol/config.yml.bak
    fi

    # Customize templates
    customize_templates "$project_path"

    # Create .gitignore
    cat > .carol/.gitignore << 'EOF'
# CAROL Framework - Git Ignore

# Temp session files
SESSION-[0-9]*-*.md

# Backup files
*.bak
*.bak[0-9]

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
EOF

    success "CAROL initialized in .carol/"
    echo ""
    echo "Next steps:"
    echo "  1. Read .carol/CAROL.md for role definitions"
    echo "  2. Activate an agent with: 'Read CAROL.md. You are assigned as [ROLE]'"
    if ! $portable; then
        echo "  3. Update framework: carol update"
    fi
}

cmd_update() {
    if [ ! -d ".carol" ]; then
        error ".carol directory not found. Run 'carol init' first."
    fi

    # Check if symlink or portable mode
    if [ -d ".carol/.git" ]; then
        # Portable mode: git pull
        info "Updating CAROL (portable mode)..."
        cd .carol && git pull origin main || error "Failed to update from remote"
        success "Updated to latest version"
    else
        # Symlink mode: Symlinks auto-update, just refresh templates
        info "Updating CAROL (symlink mode)..."

        # Check if templates were modified
        local modified=false
        if [ "templates/SESSION-LOG.md" -nt ".carol/SESSION-LOG.md" ]; then
            modified=true
        fi

        if $modified; then
            echo "Templates have been updated in SSOT."
            echo "Your customized templates are preserved."
            echo "Review changes in: $CAROL_ROOT/templates/"
        else
            success "Already up to date (symlinks auto-update)"
        fi
    fi
}

cmd_version() {
    echo "CAROL Framework v$VERSION"
    echo "Root: $CAROL_ROOT"

    if [ -f ".carol/config.yml" ]; then
        echo ""
        echo "Current project:"
        grep "name:" .carol/config.yml | head -1 | sed 's/.*: /  /'
        grep "mode:" .carol/config.yml | head -1 | sed 's/.*: /  Mode: /'
    fi
}

cmd_help() {
    cat << 'EOF'
CAROL Framework CLI Tool

Usage:
  carol <command> [options]

Commands:
  init [path]           Initialize CAROL in project directory (default: current)
  init --portable       Initialize in portable mode (full copy)
  update                Update CAROL framework from SSOT
  version               Show CAROL version
  help                  Show this help message

Examples:
  carol init                     # Initialize with symlinks (default)
  carol init --portable          # Initialize portable mode
  carol init /path/to/project    # Initialize in specific directory
  carol update                   # Update framework

Documentation:
  After init, read .carol/CAROL.md for complete role definitions

  Available roles:
    ANALYST       - Requirements analyst and planner
    SCAFFOLDER    - Literal code generator
    CARETAKER     - Code polisher and reviewer
    INSPECTOR     - Pre-commit auditor
    SURGEON       - Complex fix specialist
    JOURNALIST    - Documentation synthesizer

For more information: https://github.com/user/carol
EOF
}

# Main command dispatcher
case "${1:-help}" in
    init)
        shift
        cmd_init "$@"
        ;;
    update)
        cmd_update
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'carol help' for usage"
        exit 1
        ;;
esac
