#!/bin/bash
# carol - CAROL Framework CLI Tool
# Version: 2.1.0

VERSION="2.1.0"

# Resolve CAROL_ROOT handling symlinks (e.g. if /usr/local/bin/carol -> ~/.carol/bin/carol)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
    DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
CAROL_ROOT="$( cd -P "$( dirname "$SOURCE" )/.." >/dev/null 2>&1 && pwd )"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
GREY='\033[0;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Logo banner with gradient (cyan → magenta)
ansi_art_lines=(
    "\033[38;2;0;212;255m    ████████     ████     ██████████     ████████   ████        \033[0m"
    "\033[38;2;51;170;255m  ████░░░░░░   ████████   ████░░░░████ ████░░░░████ ████        \033[0m"
    "\033[38;2;102;128;255m████░░       ████░░░░████ ████    ████ ████    ████ ████        \033[0m"
    "\033[38;2;153;102;255m████         ████    ████ ██████████░░ ████    ████ ████        \033[0m"
    "\033[38;2;178;76;230m████         ████████████ ████░░████   ████    ████ ████        \033[0m"
    "\033[38;2;204;51;204m░░████       ████░░░░████ ████  ░░████ ████    ████ ████        \033[0m"
    "\033[38;2;230;25;179m  ░░████████ ████    ████ ████    ████ ░░████████░░ ████████████\033[0m"
    "\033[38;2;255;0;153m    ░░░░░░░░ ░░░░    ░░░░ ░░░░    ░░░░   ░░░░░░░░   ░░░░░░░░░░░░\033[0m"
)

show_banner() {
    echo ""
    for line in "${ansi_art_lines[@]}"; do
        echo -e "$line"
    done
    echo ""
    echo -e "${CYAN}Cognitive Amplification Role Orchestration for LLM agents${NC}"
}

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${YELLOW}→ $1${NC}"
}

notice() {
    echo -e "${BLUE}ℹ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

get_remote_version() {
    local version=""
    version=$(curl -fsSL https://raw.githubusercontent.com/jrengmusic/carol/main/bin/carol 2>/dev/null | grep '^VERSION=' | head -1 | cut -d'"' -f2)
    echo "$version"
}

version_greater_than() {
    [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]
}

get_relative_path() {
    local target="$1"
    local base="$2"
    python3 -c "import os.path; print(os.path.relpath('$target', '$base'))"
}

customize_templates() {
    local project_path="$1"
    local project_name=$(basename "$project_path")
    local date=$(date +"%Y-%m-%d")

    if [ -f "carol/SPRINT-LOG.md" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[Project Name\]/$project_name/g" carol/SPRINT-LOG.md
            sed -i '' "s/\[YYYY-MM-DD\]/$date/g" carol/SPRINT-LOG.md
            sed -i '' "s|\[repo-url or local path\]|$project_path|g" carol/SPRINT-LOG.md
        else
            sed -i "s/\[Project Name\]/$project_name/g" carol/SPRINT-LOG.md
            sed -i "s/\[YYYY-MM-DD\]/$date/g" carol/SPRINT-LOG.md
            sed -i "s|\[repo-url or local path\]|$project_path|g" carol/SPRINT-LOG.md
        fi
    fi

    if [ -f "carol/config.yml" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[PROJECT_NAME\]/$project_name/g" carol/config.yml
            sed -i '' "s|\[PROJECT_PATH\]|$project_path|g" carol/config.yml
            sed -i '' "s/\[DATE\]/$date/g" carol/config.yml
        else
            sed -i "s/\[PROJECT_NAME\]/$project_name/g" carol/config.yml
            sed -i "s|\[PROJECT_PATH\]|$project_path|g" carol/config.yml
            sed -i "s/\[DATE\]/$date/g" carol/config.yml
        fi
    fi
}

cmd_init() {
    local project_path="."
    local portable=false

    while [ $# -gt 0 ]; do
        case "$1" in
            --portable)
                portable=true
                shift
                ;;
            -*)
                error "Unknown flag: $1"
                ;;
            *)
                if [ "$project_path" = "." ]; then
                    project_path="$1"
                fi
                shift
                ;;
        esac
    done

    cd "$project_path" || error "Cannot access directory: $project_path"
    project_path="$(pwd)"

    if [ -d "carol" ] || [ -d ".carol" ]; then
        echo -e "${MAGENTA}${BOLD}ℹ CAROL already initiated.${NC}"
        echo ""
        echo "  carol reset   Remove and start fresh"
        echo "  carol update  Update framework"
        echo ""
        exit 0
    fi

    mkdir -p carol
    # Hide directory (without dot-prefix, keeps LLM tools happy)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        chflags hidden carol
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "win32" ]]; then
        attrib +h carol 2>/dev/null
    fi

    if $portable; then
        cp -r "$CAROL_ROOT"/* carol/
        rm -rf carol/.git carol/.gitignore
        
        # Restore SPRINT-LOG from backup or use template
        if [ -f ".carol-history/SPRINT-LOG.md" ]; then
            cp ".carol-history/SPRINT-LOG.md" carol/SPRINT-LOG.md
            rm -rf .carol-history
            notice "SPRINT-LOG.md restored from backup"
        elif [ -f "carol/templates/SPRINT-LOG.md" ]; then
            cp carol/templates/SPRINT-LOG.md carol/SPRINT-LOG.md
        fi
        
        mkdir -p .opencode/agents
        if [ -d "$CAROL_ROOT/roles" ]; then
            cp "$CAROL_ROOT/roles"/*.md .opencode/agents/
        fi

        # Hide OpenCode default agents (plan, build)
        mkdir -p .opencode
        cat > .opencode/opencode.json << 'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "plan": {
      "hidden": true
    },
    "build": {
      "hidden": true
    }
  }
}
EOF

        # Create CAROL custom commands
        mkdir -p .opencode/commands
        
        # Counselor command
        cat > .opencode/commands/counselor.md << 'EOF'
---
description: Activate COUNSELOR agent for planning and specification
agent: counselor
---

@carol/CAROL.md

You are now acting as COUNSELOR.

**MANDATORY FIRST STEP:**
Acknowledge your activation by replying:

```
COUNSELOR ready to Rock 'n Roll!

Role: COUNSELOR
Responsibility: Domain specific strategic analysis
Constraints:
- READ-ONLY for code (never write/modify code)
- Transform user intent into formal specifications
- Delegate implementation to ENGINEER or handoff to SURGEON
- Ask clarifying questions before writing plans

Standing by for your instructions.
```

**THEN WAIT for user direction.** Do NOT invoke @pathfinder. Do NOT start working.

Only after user gives you specific direction:
- ALWAYS invoke @pathfinder first
- You are READ-ONLY for code
- Delegate implementation to ENGINEER
- Handoff bug fixes to SURGEON
EOF

        # Surgeon command  
        cat > .opencode/commands/surgeon.md << 'EOF'
---
description: Activate SURGEON agent for bug fixes and implementation
agent: surgeon
---

@carol/CAROL.md

You are now acting as SURGEON.

**MANDATORY FIRST STEP:**
Acknowledge your activation by replying:

```
SURGEON ready to Rock 'n Roll!

Role: SURGEON
Responsibility: Surgical precision problem solving
Constraints:
- Surgical fixes only (minimal changes, scoped impact)
- Never refactor beyond the fix
- Handle complex bugs, edge cases, performance issues
- Work with RESET context when provided

Standing by for your instructions.
```

**THEN WAIT for user direction.** Do NOT invoke @pathfinder. Do NOT start working.

Only after user gives you specific direction:
- ALWAYS invoke @pathfinder first
- Provide surgical fixes only
- Minimal changes, scoped impact
- Do not refactor beyond the fix
EOF

        if [ -f "carol/templates/config.yml" ]; then
            cp carol/templates/config.yml carol/config.yml
        fi
    else
        # Use ABSOLUTE paths for symlinks - LLM tools often don't follow relative symlinks
        ln -sf "$CAROL_ROOT/CAROL.md" carol/CAROL.md
        [ -f "$CAROL_ROOT/INTERVIEW.md" ] && ln -sf "$CAROL_ROOT/INTERVIEW.md" carol/INTERVIEW.md
        ln -sf "$CAROL_ROOT/PATTERNS.md" carol/PATTERNS.md
        ln -sf "$CAROL_ROOT/SCRIPTS.md" carol/SCRIPTS.md
        ln -sf "$CAROL_ROOT/PATTERNS-WRITER.md" carol/PATTERNS-WRITER.md
        ln -sf "$CAROL_ROOT/SPEC-WRITER.md" carol/SPEC-WRITER.md
        ln -sf "$CAROL_ROOT/ARCHITECTURE-WRITER.md" carol/ARCHITECTURE-WRITER.md
        [ -f "$CAROL_ROOT/ARCHITECTURAL-MANIFESTO.md" ] && ln -sf "$CAROL_ROOT/ARCHITECTURAL-MANIFESTO.md" carol/ARCHITECTURAL-MANIFESTO.md
        [ -f "$CAROL_ROOT/NAMING-CONVENTION.md" ] && ln -sf "$CAROL_ROOT/NAMING-CONVENTION.md" carol/NAMING-CONVENTION.md
        
        # Create actual directories and symlink individual files with absolute paths
        if [ -d "$CAROL_ROOT/scripts" ]; then
            mkdir -p carol/scripts
            for script_file in "$CAROL_ROOT/scripts"/*; do
                [ -f "$script_file" ] && ln -sf "$script_file" "carol/scripts/$(basename "$script_file")"
            done
        fi
        if [ -d "$CAROL_ROOT/roles" ]; then
            mkdir -p carol/roles
            for role_file in "$CAROL_ROOT/roles"/*.md; do
                [ -f "$role_file" ] && ln -sf "$role_file" "carol/roles/$(basename "$role_file")"
            done
        fi

        # Restore SPRINT-LOG from backup or use template
        if [ -f ".carol-history/SPRINT-LOG.md" ]; then
            cp ".carol-history/SPRINT-LOG.md" carol/SPRINT-LOG.md
            rm -rf .carol-history
            notice "SPRINT-LOG.md restored from backup"
        elif [ -f "$CAROL_ROOT/templates/SPRINT-LOG.md" ]; then
            cp "$CAROL_ROOT/templates/SPRINT-LOG.md" carol/SPRINT-LOG.md
        fi

        if [ -f "$CAROL_ROOT/templates/config.yml" ]; then
            cp "$CAROL_ROOT/templates/config.yml" carol/config.yml
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' 's/mode: "portable"/mode: "symlink"/' carol/config.yml
            else
                sed -i 's/mode: "portable"/mode: "symlink"/' carol/config.yml
            fi
        fi

        mkdir -p .opencode/agents
        if [ -d "$CAROL_ROOT/roles" ]; then
            for role_file in "$CAROL_ROOT/roles"/*.md; do
                [ -f "$role_file" ] && ln -sf "$role_file" ".opencode/agents/$(basename "$role_file")" 2>/dev/null
            done
        fi

        # Hide OpenCode default agents (plan, build)
        cat > .opencode/opencode.json << 'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "plan": {
      "hidden": true
    },
    "build": {
      "hidden": true
    }
  }
}
EOF

        # Create CAROL custom commands
        mkdir -p .opencode/commands
        
        # Counselor command
        cat > .opencode/commands/counselor.md << 'EOF'
---
description: Activate COUNSELOR agent for planning and specification
agent: counselor
---

@carol/CAROL.md

You are now acting as COUNSELOR.

**MANDATORY FIRST STEP:**
Acknowledge your activation by replying:

```
COUNSELOR ready to Rock 'n Roll!

Role: COUNSELOR
Responsibility: Domain specific strategic analysis
Constraints:
- READ-ONLY for code (never write/modify code)
- Transform user intent into formal specifications
- Delegate implementation to ENGINEER or handoff to SURGEON
- Ask clarifying questions before writing plans

Standing by for your instructions.
```

**THEN WAIT for user direction.** Do NOT invoke @pathfinder. Do NOT start working.

Only after user gives you specific direction:
- ALWAYS invoke @pathfinder first
- You are READ-ONLY for code
- Delegate implementation to ENGINEER
- Handoff bug fixes to SURGEON
EOF

        # Surgeon command  
        cat > .opencode/commands/surgeon.md << 'EOF'
---
description: Activate SURGEON agent for bug fixes and implementation
agent: surgeon
---

@carol/CAROL.md

You are now acting as SURGEON.

**MANDATORY FIRST STEP:**
Acknowledge your activation by replying:

```
SURGEON ready to Rock 'n Roll!

Role: SURGEON
Responsibility: Surgical precision problem solving
Constraints:
- Surgical fixes only (minimal changes, scoped impact)
- Never refactor beyond the fix
- Handle complex bugs, edge cases, performance issues
- Work with RESET context when provided

Standing by for your instructions.
```

**THEN WAIT for user direction.** Do NOT invoke @pathfinder. Do NOT start working.

Only after user gives you specific direction:
- ALWAYS invoke @pathfinder first
- Provide surgical fixes only
- Minimal changes, scoped impact
- Do not refactor beyond the fix
EOF
    fi

    customize_templates "$project_path"

    show_banner
    echo -e "${GREY}✓ v${VERSION} System initiated.${NC}"
    echo ""
    echo "Rock 'n Roll!"
}

cmd_update() {
    show_banner
    
    if [ ! -d "carol" ] && [ ! -d ".carol" ]; then
        info "Updating CAROL..."
        
        local old_pwd="$PWD"
        cd "$CAROL_ROOT" || error "Cannot access CAROL root"
        
        local current_version="$VERSION"
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date (v$current_version)"
            cd "$old_pwd"
            return 0
        fi
        
        local remote_version=$(get_remote_version)
        
        if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$current_version"; then
            notice "New version available: v$current_version → v$remote_version"
        fi
        
        info "Updating CAROL SSOT at $CAROL_ROOT..."
        git reset --hard origin/main || error "Failed to update"
        
        local new_version=$(grep '^VERSION=' bin/carol | head -1 | cut -d'"' -f2)
        success "Updated CAROL SSOT: v$current_version → v$new_version"
        
        cd "$old_pwd"
        
        notice "All symlinked projects now use the updated version"
        return 0
    fi

    # Determine carol directory (new: carol, legacy: .carol)
    local carol_dir="carol"
    [ -d ".carol" ] && carol_dir=".carol"

    local is_portable=false
    if [ -d "$carol_dir/.git" ]; then
        is_portable=true
    fi

    if $is_portable; then
        info "Updating CAROL (portable mode)..."
        
        cd "$carol_dir" || error "Cannot access $carol_dir directory"
        
        if ! git remote get-url origin &>/dev/null; then
            git remote add origin https://github.com/jrengmusic/carol.git
        fi
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date"
            cd ..
            return 0
        fi
        
        info "Updating from $(git rev-parse --short HEAD) to $(git rev-parse --short origin/main)"
        git reset --hard origin/main || error "Failed to update"
        
        success "Updated to latest version"
        cd ..
    else
        info "Updating CAROL (symlink mode)..."
        
        local old_pwd="$PWD"
        cd "$CAROL_ROOT" || error "Cannot access CAROL root"
        
        local current_version="$VERSION"
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date (v$current_version)"
            cd "$old_pwd"
            return 0
        fi
        
        local remote_version=$(get_remote_version)
        
        if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$current_version"; then
            notice "New version available: v$current_version → v$remote_version"
        fi
        
        info "Updating CAROL SSOT..."
        git reset --hard origin/main || error "Failed to update"
        
        local new_version=$(grep '^VERSION=' bin/carol | head -1 | cut -d'"' -f2)
        success "Updated CAROL SSOT: v$current_version → v$new_version"
        
        cd "$old_pwd"
        
        notice "All symlinked projects now use the updated version"
    fi
}

cmd_version() {
    show_banner
    echo -e "${GREY}✓ v${VERSION}${NC}"
    echo ""
    
    local remote_version=$(get_remote_version)
    if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$VERSION"; then
        notice "Update available: v$VERSION → v$remote_version"
        echo "  Run 'carol update' to upgrade"
        echo ""
    fi
}

cmd_reset() {
    if [ ! -d "carol" ] && [ ! -d ".carol" ]; then
        notice "No CAROL workflow found in current directory"
        return 0
    fi

    echo ""
    echo -e "${CYAN}${BOLD}⚠ This will remove CAROL from:${NC}"
    echo "  $(pwd)"
    echo ""
    echo -en "${MAGENTA}Are you sure? [y/N]${NC} "
    read -r response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        # Preserve SPRINT-LOG.md if it exists
        local sprint_log=""
        if [ -f "carol/SPRINT-LOG.md" ]; then
            sprint_log=$(cat "carol/SPRINT-LOG.md")
        elif [ -f ".carol/SPRINT-LOG.md" ]; then
            sprint_log=$(cat ".carol/SPRINT-LOG.md")
        fi
        
        rm -rf carol .carol
        rm -rf .opencode/agents
        rm -rf .opencode/commands
        rm -f .opencode/opencode.json
        [ -d ".opencode" ] && rmdir .opencode 2>/dev/null
        
        # Restore SPRINT-LOG.md for next init
        if [ -n "$sprint_log" ]; then
            mkdir -p .carol-history
            echo "$sprint_log" > .carol-history/SPRINT-LOG.md
            notice "SPRINT-LOG.md preserved in .carol-history/"
        fi
        
        echo -e "${YELLOW}✓ No CAROL, no cigar${NC}"
    else
        info "Cancelled"
    fi
}

cmd_help() {
    show_banner
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  carol <command> [options]"
    echo ""
    echo -e "${MAGENTA}Commands:${NC}"
    echo -e "  ${YELLOW}init${NC} [path]           Initialize CAROL in project directory"
    echo -e "  ${YELLOW}init --portable${NC}       Initialize in portable mode (full copy)"
    echo -e "  ${YELLOW}reset${NC}                 Remove CAROL from current project"
    echo -e "  ${YELLOW}update${NC}                Update CAROL framework"
    echo -e "  ${YELLOW}version${NC}               Show CAROL version"
    echo -e "  ${YELLOW}help${NC}                  Show this help message"
    echo ""
    echo -e "${MAGENTA}PRIMARY Agents:${NC}"
    echo -e "  ${CYAN}COUNSELOR${NC}     Planning, specs, docs, SPRINT-LOG"
    echo -e "  ${CYAN}SURGEON${NC}       Execution, fixes, surgical precision"
    echo ""
    echo -e "${MAGENTA}Secondary Agents:${NC}"
    echo -e "  ${CYAN}Engineer${NC}      Code generation"
    echo -e "  ${CYAN}Oracle${NC}        Deep analysis, research"
    echo -e "  ${CYAN}Librarian${NC}     Library/framework research"
    echo -e "  ${CYAN}Auditor${NC}       QA/QC validation"
    echo -e "  ${CYAN}Machinist${NC}     Polish, finish"
    echo -e "  ${CYAN}Pathfinder${NC}    Pattern discovery"
    echo -e "  ${CYAN}Researcher${NC}    Domain research"
    echo -e "  ${CYAN}Validator${NC}     Spec & compliance checking"
    echo ""
    echo -e "${MAGENTA}Activate:${NC}"
    echo -e "  ${YELLOW}@CAROL.md [ROLE]: Rock 'n Roll${NC}"
    echo ""
    echo -e "  ${GREY}OpenCode${NC}    Press Tab to switch roles"
    echo -e "  ${GREY}Others${NC}      @CAROL.md Rock 'n Role: [ROLE]"
    echo ""
    echo -e "${GREY}https://github.com/jrengmusic/carol${NC}"
    echo ""
}

# Main command dispatcher
case "${1:-help}" in
    init)
        shift
        cmd_init "$@"
        ;;
    reset)
        cmd_reset
        ;;
    update)
        cmd_update
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'carol help' for usage"
        exit 1
        ;;
esac
