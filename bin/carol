#!/bin/bash
# carol - CAROL Framework CLI Tool
# Version: 1.0.0

VERSION="1.0.0"
CAROL_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${YELLOW}→ $1${NC}"
}

notice() {
    echo -e "${BLUE}ℹ $1${NC}"
}

get_remote_version() {
    local version=""
    # Try to fetch version from remote
    version=$(curl -fsSL https://raw.githubusercontent.com/jrengmusic/carol/main/bin/carol 2>/dev/null | grep '^VERSION=' | head -1 | cut -d'"' -f2)
    echo "$version"
}

version_greater_than() {
    # Compare versions: returns 0 if $1 > $2
    [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]
}

customize_templates() {
    local project_path="$1"
    local project_name=$(basename "$project_path")
    local date=$(date +"%Y-%m-%d")

    # Customize SESSION-LOG.md
    if [ -f ".carol/SESSION-LOG.md" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[Project Name\]/$project_name/g" .carol/SESSION-LOG.md
            sed -i '' "s/\[YYYY-MM-DD\]/$date/g" .carol/SESSION-LOG.md
            sed -i '' "s|\[repo-url or local path\]|$project_path|g" .carol/SESSION-LOG.md
        else
            sed -i "s/\[Project Name\]/$project_name/g" .carol/SESSION-LOG.md
            sed -i "s/\[YYYY-MM-DD\]/$date/g" .carol/SESSION-LOG.md
            sed -i "s|\[repo-url or local path\]|$project_path|g" .carol/SESSION-LOG.md
        fi
    fi

    # Customize config.yml
    if [ -f ".carol/config.yml" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[PROJECT_NAME\]/$project_name/g" .carol/config.yml
            sed -i '' "s|\[PROJECT_PATH\]|$project_path|g" .carol/config.yml
            sed -i '' "s/\[DATE\]/$date/g" .carol/config.yml
        else
            sed -i "s/\[PROJECT_NAME\]/$project_name/g" .carol/config.yml
            sed -i "s|\[PROJECT_PATH\]|$project_path|g" .carol/config.yml
            sed -i "s/\[DATE\]/$date/g" .carol/config.yml
        fi
    fi
}

cmd_init() {
    local project_path="."
    local portable=false

    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            --portable)
                portable=true
                shift
                ;;
            -*)
                error "Unknown flag: $1"
                ;;
            *)
                # First non-flag argument is project path
                if [ "$project_path" = "." ]; then
                    project_path="$1"
                fi
                shift
                ;;
        esac
    done

    # Change to project directory
    cd "$project_path" || error "Cannot access directory: $project_path"
    project_path="$(pwd)"

    # Check if .carol already exists
    if [ -d ".carol" ]; then
        error ".carol directory already exists. Remove it first or run 'carol update'"
    fi

    # Create .carol directory
    mkdir -p .carol

    if $portable; then
        # Portable mode: Clone full repository
        info "Initializing CAROL (portable mode)..."
        if ! git clone https://github.com/jrengmusic/carol.git .carol; then
            error "Failed to clone CAROL repository"
        fi
        
        # Clean up git files
        rm -rf .carol/.git
        
        success "CAROL cloned (portable mode)"
    else
        # Symlink mode: Link to SSOT
        info "Initializing CAROL (symlink mode)..."

        # Symlink shared resources
        ln -s "$CAROL_ROOT/CAROL.md" .carol/CAROL.md
        ln -s "$CAROL_ROOT/INTERVIEW.md" .carol/INTERVIEW.md
        ln -s "$CAROL_ROOT/PATTERNS.md" .carol/PATTERNS.md
        ln -s "$CAROL_ROOT/SCRIPTS.md" .carol/SCRIPTS.md
        ln -s "$CAROL_ROOT/PATTERNS-WRITER.md" .carol/PATTERNS-WRITER.md
        ln -s "$CAROL_ROOT/SPEC-WRITER.md" .carol/SPEC-WRITER.md
        ln -s "$CAROL_ROOT/ARCHITECTURE-WRITER.md" .carol/ARCHITECTURE-WRITER.md
        ln -s "$CAROL_ROOT/scripts" .carol/scripts 2>/dev/null || true

        # Copy templates (project-specific)
        cp "$CAROL_ROOT/templates/SESSION-LOG.md" .carol/SESSION-LOG.md
        cp "$CAROL_ROOT/templates/ARCHITECTURE.md" .carol/ARCHITECTURE.md
        cp "$CAROL_ROOT/templates/config.yml" .carol/config.yml

        # Mark as symlink mode in config
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' 's/mode: "portable"/mode: "symlink"/' .carol/config.yml
        else
            sed -i 's/mode: "portable"/mode: "symlink"/' .carol/config.yml
        fi
    fi

    # Customize templates
    customize_templates "$project_path"

    # Create .gitignore
    cat > .carol/.gitignore << 'EOF'
# CAROL Framework - Git Ignore

# Temp session files
SESSION-[0-9]*-*.md

# Backup files
*.bak
*.bak[0-9]

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
EOF

    success "CAROL initialized in .carol/"
    echo ""
    echo "Next steps:"
    echo "  1. Read .carol/CAROL.md for role definitions"
    echo "  2. Activate an agent with: 'Read CAROL.md. You are assigned as [ROLE]'"
    if ! $portable; then
        echo "  3. Update framework: carol update"
    fi
}

cmd_update() {
    if [ ! -d ".carol" ]; then
        error ".carol directory not found. Run 'carol init' first."
    fi

    # Determine mode by checking for git directory
    local is_portable=false
    if [ -d ".carol/.git" ]; then
        is_portable=true
    fi

    if $is_portable; then
        # Portable mode: Update the project's .carol copy
        info "Updating CAROL (portable mode)..."
        
        cd .carol || error "Cannot access .carol directory"
        
        # Check if git remote exists
        if ! git remote get-url origin &>/dev/null; then
            # Add remote if missing
            git remote add origin https://github.com/jrengmusic/carol.git
        fi
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date"
            cd ..
            return 0
        fi
        
        info "Updating from $(git rev-parse --short HEAD) to $(git rev-parse --short origin/main)"
        git reset --hard origin/main || error "Failed to update"
        
        success "Updated to latest version"
        cd ..
    else
        # Symlink mode: Update the SSOT at ~/.carol
        info "Updating CAROL (symlink mode)..."
        
        local old_pwd="$PWD"
        cd "$CAROL_ROOT" || error "Cannot access CAROL root"
        
        # Check current version
        local current_version="$VERSION"
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date (v$current_version)"
            cd "$old_pwd"
            return 0
        fi
        
        # Get remote version before updating
        local remote_version=$(get_remote_version)
        
        if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$current_version"; then
            notice "New version available: v$current_version → v$remote_version"
        fi
        
        info "Updating CAROL SSOT..."
        git reset --hard origin/main || error "Failed to update"
        
        local new_version=$(grep '^VERSION=' bin/carol | head -1 | cut -d'"' -f2)
        success "Updated CAROL SSOT: v$current_version → v$new_version"
        
        cd "$old_pwd"
        
        # Notify about symlinked projects
        notice "All symlinked projects now use the updated version"
    fi
}

cmd_version() {
    echo "CAROL Framework v$VERSION"
    echo "Root: $CAROL_ROOT"

    if [ -f ".carol/config.yml" ]; then
        echo ""
        echo "Current project:"
        grep "name:" .carol/config.yml | head -1 | sed 's/.*: /  /'
        grep "mode:" .carol/config.yml | head -1 | sed 's/.*: /  Mode: /'
    fi
    
    # Check for updates
    local remote_version=$(get_remote_version)
    if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$VERSION"; then
        echo ""
        notice "New version available: v$VERSION → v$remote_version"
        echo "  Run 'carol update' to upgrade"
    fi
}

cmd_help() {
    cat << 'EOF'
CAROL Framework CLI Tool

Usage:
  carol <command> [options]

Commands:
  init [path]           Initialize CAROL in project directory (default: current)
  init --portable       Initialize in portable mode (full copy)
  update                Update CAROL framework from SSOT
  version               Show CAROL version and check for updates
  help                  Show this help message

Examples:
  carol init                     # Initialize with symlinks (default)
  carol init --portable          # Initialize portable mode
  carol init /path/to/project    # Initialize in specific directory
  carol update                   # Update framework

Documentation:
  After init, read .carol/CAROL.md for complete role definitions

  Available roles:
    ANALYST       - Requirements analyst and planner
    SCAFFOLDER    - Literal code generator
    CARETAKER     - Code polisher and reviewer
    INSPECTOR     - Pre-commit auditor
    SURGEON       - Complex fix specialist
    JOURNALIST    - Documentation synthesizer

For more information: https://github.com/jrengmusic/carol
EOF
}

# Main command dispatcher
case "${1:-help}" in
    init)
        shift
        cmd_init "$@"
        ;;
    update)
        cmd_update
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'carol help' for usage"
        exit 1
        ;;
esac
