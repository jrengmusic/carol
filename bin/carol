#!/bin/bash
# carol - CAROL Framework CLI Tool
# Version: 1.2.0

VERSION="1.2.0"
CAROL_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
GREY='\033[0;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Logo banner with gradient (cyan → magenta)
ansi_art_lines=(
    "\033[38;2;0;212;255m    ████████     ████     ██████████     ████████   ████        \033[0m"
    "\033[38;2;51;170;255m  ████░░░░░░   ████████   ████░░░░████ ████░░░░████ ████        \033[0m"
    "\033[38;2;102;128;255m████░░       ████░░░░████ ████    ████ ████    ████ ████        \033[0m"
    "\033[38;2;153;102;255m████         ████    ████ ██████████░░ ████    ████ ████        \033[0m"
    "\033[38;2;178;76;230m████         ████████████ ████░░████   ████    ████ ████        \033[0m"
    "\033[38;2;204;51;204m░░████       ████░░░░████ ████  ░░████ ████    ████ ████        \033[0m"
    "\033[38;2;230;25;179m  ░░████████ ████    ████ ████    ████ ░░████████░░ ████████████\033[0m"
    "\033[38;2;255;0;153m    ░░░░░░░░ ░░░░    ░░░░ ░░░░    ░░░░   ░░░░░░░░   ░░░░░░░░░░░░\033[0m"
)

show_banner() {
    echo ""
    for line in "${ansi_art_lines[@]}"; do
        echo -e "$line"
    done
    echo ""
    echo -e "${CYAN}Cognitive Amplification Role Orchestration for LLM agents${NC}"
}

# Helper functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓ $1${NC}"
}

info() {
    echo -e "${YELLOW}→ $1${NC}"
}

notice() {
    echo -e "${BLUE}ℹ $1${NC}"
}

warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

get_remote_version() {
    local version=""
    version=$(curl -fsSL https://raw.githubusercontent.com/jrengmusic/carol/main/bin/carol 2>/dev/null | grep '^VERSION=' | head -1 | cut -d'"' -f2)
    echo "$version"
}

version_greater_than() {
    [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]
}

customize_templates() {
    local project_path="$1"
    local project_name=$(basename "$project_path")
    local date=$(date +"%Y-%m-%d")

    if [ -f ".carol/SPRINT-LOG.md" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[Project Name\]/$project_name/g" .carol/SPRINT-LOG.md
            sed -i '' "s/\[YYYY-MM-DD\]/$date/g" .carol/SPRINT-LOG.md
            sed -i '' "s|\[repo-url or local path\]|$project_path|g" .carol/SPRINT-LOG.md
        else
            sed -i "s/\[Project Name\]/$project_name/g" .carol/SPRINT-LOG.md
            sed -i "s/\[YYYY-MM-DD\]/$date/g" .carol/SPRINT-LOG.md
            sed -i "s|\[repo-url or local path\]|$project_path|g" .carol/SPRINT-LOG.md
        fi
    fi

    if [ -f ".carol/config.yml" ]; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/\[PROJECT_NAME\]/$project_name/g" .carol/config.yml
            sed -i '' "s|\[PROJECT_PATH\]|$project_path|g" .carol/config.yml
            sed -i '' "s/\[DATE\]/$date/g" .carol/config.yml
        else
            sed -i "s/\[PROJECT_NAME\]/$project_name/g" .carol/config.yml
            sed -i "s|\[PROJECT_PATH\]|$project_path|g" .carol/config.yml
            sed -i "s/\[DATE\]/$date/g" .carol/config.yml
        fi
    fi
}

cmd_init() {
    local project_path="."
    local portable=false

    while [ $# -gt 0 ]; do
        case "$1" in
            --portable)
                portable=true
                shift
                ;;
            -*)
                error "Unknown flag: $1"
                ;;
            *)
                if [ "$project_path" = "." ]; then
                    project_path="$1"
                fi
                shift
                ;;
        esac
    done

    cd "$project_path" || error "Cannot access directory: $project_path"
    project_path="$(pwd)"

    if [ -d ".carol" ]; then
        echo -e "${MAGENTA}${BOLD}ℹ CAROL already initiated.${NC}"
        echo ""
        echo "  carol reset   Remove and start fresh"
        echo "  carol update  Update framework"
        echo ""
        exit 0
    fi

    mkdir -p .carol

    if $portable; then
        cp -r "$CAROL_ROOT"/* .carol/
        rm -rf .carol/.git .carol/.gitignore
        
        mkdir -p .opencode/agents
        if [ -d "$CAROL_ROOT/roles" ]; then
            cp "$CAROL_ROOT/roles"/*.md .opencode/agents/
        fi
        
        if [ -f ".carol/templates/config.yml" ]; then
            cp .carol/templates/config.yml .carol/config.yml
        fi
    else
        ln -s "$CAROL_ROOT/CAROL.md" .carol/CAROL.md
        [ -f "$CAROL_ROOT/INTERVIEW.md" ] && ln -s "$CAROL_ROOT/INTERVIEW.md" .carol/INTERVIEW.md
        ln -s "$CAROL_ROOT/PATTERNS.md" .carol/PATTERNS.md
        ln -s "$CAROL_ROOT/SCRIPTS.md" .carol/SCRIPTS.md
        ln -s "$CAROL_ROOT/PATTERNS-WRITER.md" .carol/PATTERNS-WRITER.md
        ln -s "$CAROL_ROOT/SPEC-WRITER.md" .carol/SPEC-WRITER.md
        ln -s "$CAROL_ROOT/ARCHITECTURE-WRITER.md" .carol/ARCHITECTURE-WRITER.md
        [ -f "$CAROL_ROOT/ARCHITECTURAL-MANIFESTO.md" ] && ln -s "$CAROL_ROOT/ARCHITECTURAL-MANIFESTO.md" .carol/ARCHITECTURAL-MANIFESTO.md
        [ -f "$CAROL_ROOT/NAMING-CONVENTION.md" ] && ln -s "$CAROL_ROOT/NAMING-CONVENTION.md" .carol/NAMING-CONVENTION.md
        
        [ -d "$CAROL_ROOT/scripts" ] && ln -s "$CAROL_ROOT/scripts" .carol/scripts
        [ -d "$CAROL_ROOT/roles" ] && ln -s "$CAROL_ROOT/roles" .carol/roles

        [ -f "$CAROL_ROOT/templates/SPRINT-LOG.md" ] && cp "$CAROL_ROOT/templates/SPRINT-LOG.md" .carol/SPRINT-LOG.md

        if [ -f "$CAROL_ROOT/templates/config.yml" ]; then
            cp "$CAROL_ROOT/templates/config.yml" .carol/config.yml
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' 's/mode: "portable"/mode: "symlink"/' .carol/config.yml
            else
                sed -i 's/mode: "portable"/mode: "symlink"/' .carol/config.yml
            fi
        fi

        mkdir -p .opencode/agents
        if [ -d "$CAROL_ROOT/roles" ]; then
            for role_file in "$CAROL_ROOT/roles"/*.md; do
                [ -f "$role_file" ] && ln -sf "$role_file" ".opencode/agents/$(basename "$role_file")" 2>/dev/null
            done
        fi
    fi

    customize_templates "$project_path"

    cat > .carol/.gitignore << 'EOF'
# CAROL Framework - Git Ignore

# Temp sprint files
[0-9]*-*-*.md

# Backup files
*.bak
*.bak[0-9]

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
EOF

    if [ ! -f ".opencode/.gitignore" ]; then
        cat > .opencode/.gitignore << 'EOF'
# OpenCode - Git Ignore (optional)
# opencode.json
EOF
    fi

    show_banner
    echo -e "${GREY}✓ v${VERSION} System initiated.${NC}"
    echo ""
    echo "Rock 'n Roll!"
}

cmd_update() {
    show_banner
    
    if [ ! -d ".carol" ]; then
        info "Updating CAROL..."
        
        local old_pwd="$PWD"
        cd "$CAROL_ROOT" || error "Cannot access CAROL root"
        
        local current_version="$VERSION"
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date (v$current_version)"
            cd "$old_pwd"
            return 0
        fi
        
        local remote_version=$(get_remote_version)
        
        if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$current_version"; then
            notice "New version available: v$current_version → v$remote_version"
        fi
        
        info "Updating CAROL SSOT at $CAROL_ROOT..."
        git reset --hard origin/main || error "Failed to update"
        
        local new_version=$(grep '^VERSION=' bin/carol | head -1 | cut -d'"' -f2)
        success "Updated CAROL SSOT: v$current_version → v$new_version"
        
        cd "$old_pwd"
        
        notice "All symlinked projects now use the updated version"
        return 0
    fi

    local is_portable=false
    if [ -d ".carol/.git" ]; then
        is_portable=true
    fi

    if $is_portable; then
        info "Updating CAROL (portable mode)..."
        
        cd .carol || error "Cannot access .carol directory"
        
        if ! git remote get-url origin &>/dev/null; then
            git remote add origin https://github.com/jrengmusic/carol.git
        fi
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date"
            cd ..
            return 0
        fi
        
        info "Updating from $(git rev-parse --short HEAD) to $(git rev-parse --short origin/main)"
        git reset --hard origin/main || error "Failed to update"
        
        success "Updated to latest version"
        cd ..
    else
        info "Updating CAROL (symlink mode)..."
        
        local old_pwd="$PWD"
        cd "$CAROL_ROOT" || error "Cannot access CAROL root"
        
        local current_version="$VERSION"
        
        info "Fetching latest version..."
        git fetch origin main || error "Failed to fetch from remote"
        
        local current_commit=$(git rev-parse HEAD)
        local remote_commit=$(git rev-parse origin/main)
        
        if [ "$current_commit" = "$remote_commit" ]; then
            success "Already up to date (v$current_version)"
            cd "$old_pwd"
            return 0
        fi
        
        local remote_version=$(get_remote_version)
        
        if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$current_version"; then
            notice "New version available: v$current_version → v$remote_version"
        fi
        
        info "Updating CAROL SSOT..."
        git reset --hard origin/main || error "Failed to update"
        
        local new_version=$(grep '^VERSION=' bin/carol | head -1 | cut -d'"' -f2)
        success "Updated CAROL SSOT: v$current_version → v$new_version"
        
        cd "$old_pwd"
        
        notice "All symlinked projects now use the updated version"
    fi
}

cmd_version() {
    show_banner
    echo -e "${GREY}✓ v${VERSION}${NC}"
    echo ""
    
    local remote_version=$(get_remote_version)
    if [ -n "$remote_version" ] && version_greater_than "$remote_version" "$VERSION"; then
        notice "Update available: v$VERSION → v$remote_version"
        echo "  Run 'carol update' to upgrade"
        echo ""
    fi
}

cmd_reset() {
    if [ ! -d ".carol" ]; then
        notice "No CAROL workflow found in current directory"
        return 0
    fi

    echo ""
    echo -e "${CYAN}${BOLD}⚠ This will remove CAROL from:${NC}"
    echo "  $(pwd)"
    echo ""
    echo -en "${MAGENTA}Are you sure? [y/N]${NC} "
    read -r response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        rm -rf .carol
        rm -rf .opencode/agents
        [ -d ".opencode" ] && rmdir .opencode 2>/dev/null
        echo -e "${YELLOW}✓ No CAROL, no cigar${NC}"
    else
        info "Cancelled"
    fi
}

cmd_help() {
    show_banner
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo "  carol <command> [options]"
    echo ""
    echo -e "${MAGENTA}Commands:${NC}"
    echo -e "  ${YELLOW}init${NC} [path]           Initialize CAROL in project directory"
    echo -e "  ${YELLOW}init --portable${NC}       Initialize in portable mode (full copy)"
    echo -e "  ${YELLOW}reset${NC}                 Remove CAROL from current project"
    echo -e "  ${YELLOW}update${NC}                Update CAROL framework"
    echo -e "  ${YELLOW}version${NC}               Show CAROL version"
    echo -e "  ${YELLOW}help${NC}                  Show this help message"
    echo ""
    echo -e "${MAGENTA}Roles:${NC}"
    echo -e "  ${CYAN}COUNSELOR${NC}       Requirements counselor and planner"
    echo -e "  ${CYAN}ENGINEER${NC}      Literal code generator"
    echo -e "  ${CYAN}MACHINIST${NC}     Code polisher and reviewer"
    echo -e "  ${CYAN}AUDITOR${NC}       Pre-commit auditor"
    echo -e "  ${CYAN}SURGEON${NC}       Complex fix specialist"
    echo -e "  ${CYAN}JOURNALIST${NC}    Documentation synthesizer"
    echo ""
    echo -e "${MAGENTA}Activate:${NC}"
    echo -e "  ${YELLOW}@CAROL.md [ROLE]: Rock 'n Roll${NC}"
    echo ""
    echo -e "  ${GREY}OpenCode${NC}    Press Tab to switch roles"
    echo -e "  ${GREY}Others${NC}      @CAROL.md Rock 'n Role: [ROLE]"
    echo ""
    echo -e "${GREY}https://github.com/jrengmusic/carol${NC}"
    echo ""
}

# Main command dispatcher
case "${1:-help}" in
    init)
        shift
        cmd_init "$@"
        ;;
    reset)
        cmd_reset
        ;;
    update)
        cmd_update
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'carol help' for usage"
        exit 1
        ;;
esac
